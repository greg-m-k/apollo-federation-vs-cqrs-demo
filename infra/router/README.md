# Apollo Router

Configuration for the Apollo Router that composes the federated supergraph.

## Directory Structure

```
router/
└── federation/
    ├── supergraph.yaml      # Composition config (references service schemas)
    ├── supergraph.graphql   # Composed output (committed for k8s)
    ├── router.yaml          # Router runtime config
    ├── timing.rhai          # Rhai script for timing header propagation
    ├── compose-supergraph.sh
    └── Dockerfile
```

## Schema Ownership

**Important:** Subgraph schemas live with their services, not here.

```
services/federation/
├── hr-subgraph/schema.graphql         # HR team owns this
├── employment-subgraph/schema.graphql # Employment team owns this
└── security-subgraph/schema.graphql   # Security team owns this
```

The `supergraph.yaml` pulls from these locations:
```yaml
subgraphs:
  hr:
    schema:
      file: ../../../services/federation/hr-subgraph/schema.graphql
```

This makes it clear that each team owns their schema, and the router just composes them.

## Composing the Supergraph

When subgraph schemas change, recompose:

```bash
cd infra/router/federation
./compose-supergraph.sh

# Or manually:
rover supergraph compose --config supergraph.yaml > supergraph.graphql
```

**Requires:** [Rover CLI](https://www.apollographql.com/docs/rover/getting-started)

## Key Files

### `router.yaml`

Runtime configuration for Apollo Router:
- Enables introspection and Apollo Sandbox
- Configures CORS for dashboard
- Sets up health check endpoint (`:8088`)
- Loads the timing Rhai script

### `timing.rhai`

Rhai script that propagates timing headers from subgraphs to the final response:
- Captures `X-HR-Time-Ms`, `X-Employment-Time-Ms`, `X-Security-Time-Ms`
- Captures detailed timing breakdowns (`X-*-Timing-Details`)
- Makes timing visible in dashboard for performance comparison

### `supergraph.graphql`

The composed supergraph schema. This is:
- Generated by `rover supergraph compose`
- Committed to git (for k8s ConfigMap)
- Contains all federated types with `@join__*` directives

## Local Development

Router runs at `http://localhost:4000` with:
- GraphQL endpoint: `/`
- Apollo Sandbox: `/` (browser)
- Health check: `http://localhost:8088/health`
