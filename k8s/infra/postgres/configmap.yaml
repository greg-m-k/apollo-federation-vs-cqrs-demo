apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init
  namespace: apollo-demo
data:
  init.sql: |
    -- Create categories table
    CREATE TABLE IF NOT EXISTS categories (
        id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid()::text,
        name VARCHAR(100) NOT NULL UNIQUE,
        description VARCHAR(500),
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    -- Create products table
    CREATE TABLE IF NOT EXISTS products (
        id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid()::text,
        name VARCHAR(200) NOT NULL,
        description VARCHAR(1000),
        price DECIMAL(10,2) NOT NULL CHECK (price >= 0),
        category_id VARCHAR(36) REFERENCES categories(id) ON DELETE SET NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    CREATE INDEX IF NOT EXISTS idx_products_category ON products(category_id);

    -- Seed categories
    INSERT INTO categories (id, name, description) VALUES
        ('1', 'Electronics', 'Gadgets and devices'),
        ('2', 'Books', 'Reading materials'),
        ('3', 'Clothing', 'Apparel and accessories')
    ON CONFLICT (id) DO NOTHING;

    -- Seed products
    INSERT INTO products (id, name, description, price, category_id) VALUES
        ('1', 'Laptop', 'High-performance laptop', 999.99, '1'),
        ('2', 'Smartphone', 'Latest smartphone model', 699.99, '1'),
        ('3', 'Java Book', 'Learn Java programming', 49.99, '2'),
        ('4', 'T-Shirt', 'Cotton t-shirt', 29.99, '3'),
        ('5', 'Headphones', 'Wireless headphones', 199.99, '1')
    ON CONFLICT (id) DO NOTHING;
